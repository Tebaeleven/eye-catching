<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>文字入りアイキャッチ作るくん</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/1.3.3/FileSaver.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dom-to-image@2.6.0/dist/dom-to-image.min.js"></script>
    <link rel="stylesheet" href="./style.css">
</head>
    <body>
        <div id="back">
            <div id="container">
                <div class="canvas-box" id="src">
                    <div id="back-cube">
                        <div id="text">
                            <p id="title"></p>
                        </div>
                        <div class="icon">
                            <img src="./img/てば_400x400.jpeg" alt="">
                            <p>@Teba_eleven</p>
                            <p id="blog">チキンズブログ</p>    
                        </div>
                        
                    </div>
                </div>
                <canvas id="canvas"></canvas>
            </div>
            <div id="textarea">
                <textarea id="text_input" cols="30" rows="5">Scratchでニューラルネット
ワークを作ってみた!</textarea>
                <div class="btn">
                    <input id="download-btn" type="button" value="画像をダウンロードする！">
                    <input type="text" value="20" id="chr">
                </div>
            </div>
        </div>

        <script>

        
        
            var btn=document.getElementById("download-btn");
                btn.addEventListener("click",()=>{
                        canvas.toBlob((blob) => {
                        saveAs(blob, "image.png");
                    });
                })

            var input_dom = document.getElementById('text_input'); //入力要素
            var row_string_cnt = document.getElementById('chr'); //一行あたりの文字数
            console.log(row_string_cnt.value)
            
            canvasInput()
            
            //入力時にイベントを発火
            input_dom.addEventListener('input', function(e){
                canvasInput();
            });
            row_string_cnt.addEventListener('input', function(e){
                canvasInput();
            });
            function canvasInput(){
                row_string_cnt = document.getElementById('chr'); //一行あたりの文字数
                console.log(row_string_cnt.value)
                domtoimage.toPng(src)
                .then(function (dataUrl) {

                    // dataUrlが返ってくるのでImageを生成し生成した画像を読み込む
                    const img = new Image();
                    img.src = dataUrl;

                    // 読み込みが終わったらリサイズのために、canvasを生成しimgを描画する
                    img.onload = () => {
                        
                        const canvas = document.getElementById("canvas");

                        //キャンバスサイズ
                        canvas.width = 680;
                        canvas.height = 357;

                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, canvas.width,canvas.height);

                        // canvasをblobに変換し、FileSaverでダウンロードを行う
                        // canvasをblobに変換し、FileSaverでダウンロードを行う
                            // canvasをblobに変換し、FileSaverでダウンロードを行う

                        console.log("fafa")
                        console.log(ctx)
                        document.body.appendChild(canvas);
                    };
                })
                .catch((error) => {
                    console.log(error);
                });

                var aryText = input_dom.value.split('');
                console.log(aryText);
                //出力用の配列を用意
                var aryRow = [];
                aryRow[0] = '';
                var row_cnt = 0;

                for(var i=0;i<aryText.length;i++){
                    var text = aryText[i];
                    if(aryRow[row_cnt].length >= row_string_cnt.value){
                        row_cnt++;
                        aryRow[row_cnt] = '';
                        console.log("改行")
                    }
                    if(text == "\n"){
                        row_cnt++;
                        aryRow[row_cnt] = '';
                        text = '';
                    }
                    aryRow[row_cnt] += text;
                }
                
                console.log(aryRow);
                var text="";
                console.log(text);
                for (let i = 0; i < aryRow.length; i++) {
                    console.log("実行回数");
                    
                    
                    text=text+aryRow[i]+"<br>"
                    console.log(text);
                    document.getElementById('text').innerHTML = text;         
                    
                }
        }
        </script>

    </body>

</html>

